<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <title>Baba Mama Arcade</title>
    <style>
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; background: #000; font-family: -apple-system, sans-serif;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        #border-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 5000; border: 0px solid transparent; }

        /* RGB GLOW */
        .neon-rgb { border: 35px solid #fff; animation: rgbGlow 0.3s infinite linear; }
        @keyframes rgbGlow {
            0% { border-color: #ff0000; box-shadow: inset 0 0 40px #ff0000, 0 0 100px #ff0000; }
            33% { border-color: #00ff00; box-shadow: inset 0 0 40px #00ff00, 0 0 100px #00ff00; }
            66% { border-color: #0000ff; box-shadow: inset 0 0 40px #0000ff, 0 0 100px #0000ff; }
            100% { border-color: #ff0000; box-shadow: inset 0 0 40px #ff0000, 0 0 100px #ff0000; }
        }

        .neon-yellow { border: 35px solid #FFDE59; animation: pulseY 0.5s infinite alternate; }
        @keyframes pulseY { from { box-shadow: inset 0 0 30px #FFDE59; } to { box-shadow: inset 0 0 120px #FFDE59; } }

        .neon-purple { border: 35px solid #A020F0; animation: pulseP 0.5s infinite alternate; }
        @keyframes pulseP { from { box-shadow: inset 0 0 30px #A020F0; } to { box-shadow: inset 0 0 120px #A020F0; } }

        img.full { width: 100%; height: 100%; object-fit: cover; }
        .game-photo { width: 100%; height: 100%; object-fit: contain; background: #fff; transition: transform 0.6s ease-out; }
        
        /* SPINNING LOGIC */
        #spin-btn { width: 100%; height: 100%; object-fit: cover; transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s; }
        .spin-trigger { transform: scale(0) rotate(1080deg); opacity: 0; }
        .photo-win-spin { transform: rotate(720deg) scale(1.1); }

        .emoji { position: absolute; pointer-events: none; z-index: 6000; font-size: 60px; }
    </style>
</head>
<body onclick="handleGlobalTap()">

    <div id="border-overlay"></div>

    <div id="scr-splash" class="screen active" onclick="bootAudio()"><img src="splash.jpg" class="full"></div>
    <div id="scr-choice" class="screen" onclick="pick(event)"><img src="choice.jpg" class="full"></div>
    <div id="scr-ready" class="screen" onclick="triggerSpinPropeller()"><img src="spin.jpg" id="spin-btn"></div>
    <div id="scr-game" class="screen" onclick="checkResult()"><img id="pic" class="game-photo" src="baba1.jpg"></div>
    <div id="scr-win" class="screen" onclick="flow('choice')"><img src="win.jpg" class="full"></div>
    <div id="scr-fail" class="screen" onclick="flow('choice')"><img src="tryagain.jpg" class="full"></div>

    <script>
        var sounds = {
            bg: new Howl({ src: ['music.mp3'], loop: true, volume: 0.3, html5: true }),
            splash: new Howl({ src: ['splash.mp3'] }),
            choice: new Howl({ src: ['choice.mp3'], volume: 0.6 }),
            jackpot: new Howl({ src: ['jackpot.mp3'] }),
            win: new Howl({ src: ['win.mp3'] }),
            fail: new Howl({ src: ['fail.mp3'] }),
            spin: new Howl({ src: ['spin.mp3'] })
        };

        let userGuess = "", spinCount = 0, audioUnlocked = false, isSpinning = false, currentResult = null;
        let lastTwo = []; 
        let jackpotGoal = Math.floor(Math.random() * 3) + 3; 

        // 1. FORCED UNLOCK: The very first tap MUST call this.
        function bootAudio() {
            if (audioUnlocked) return;
            sounds.bg.play();
            sounds.splash.play();
            audioUnlocked = true;
            flow('choice');
        }

        // 2. Global tap sound for everything else
        function handleGlobalTap() {
            if (audioUnlocked) {
                sounds.choice.play();
            }
        }

        function flow(scr) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            const target = document.getElementById('scr-' + scr);
            target.style.display = 'flex';
            
            // Clean up state
            document.getElementById('border-overlay').className = "";
            const pic = document.getElementById('pic');
            pic.classList.remove('photo-win-spin');
            pic.style.transform = "";
        }

        function pick(e) {
            // Determine if top half (baba) or bottom half (mama)
            userGuess = (e.clientY < window.innerHeight / 2) ? "baba" : "mama";
            flow('ready');
            const btn = document.getElementById('spin-btn');
            btn.classList.remove('spin-trigger');
            btn.style.opacity = "1";
            btn.style.transform = "scale(1) rotate(0deg)";
        }

        function triggerSpinPropeller() {
            const btn = document.getElementById('spin-btn');
            btn.classList.add('spin-trigger');
            
            // Wait for propeller spin, then start shuffle sound
            setTimeout(() => {
                sounds.spin.play();
                flow('game');
                startSpin();
            }, 1000); 
        }

        function startSpin() {
            isSpinning = true;
            let count = 0;
            const shuffleInterval = setInterval(() => {
                let tempType = Math.random() > 0.5 ? "baba" : "mama";
                document.getElementById('pic').src = tempType + (Math.floor(Math.random()*10)+1) + ".jpg";
                if(++count > 30) { 
                    clearInterval(shuffleInterval);
                    isSpinning = false;
                    prepareResult();
                }
            }, 100);
        }

        function prepareResult() {
            spinCount++;
            let isJP = (spinCount >= jackpotGoal);
            let finalType;

            // Anti-repeat logic
            if (isJP) {
                finalType = "jackpot";
            } else {
                if (lastTwo.length === 2 && lastTwo[0] === lastTwo[1]) {
                    finalType = (lastTwo[0] === "baba") ? "mama" : "baba";
                } else {
                    finalType = Math.random() > 0.5 ? "baba" : "mama";
                }
            }

            lastTwo.push(finalType);
            if (lastTwo.length > 2) lastTwo.shift();

            let resultFile = isJP ? "babamama.jpg" : finalType + (Math.floor(Math.random()*10)+1) + ".jpg";
            document.getElementById('pic').src = resultFile;
            
            // Winning photo spin effect
            document.getElementById('pic').classList.add('photo-win-spin');
            
            currentResult = { isJP, isMama: resultFile.includes("mama") };
            const overlay = document.getElementById('border-overlay');
            
            if(isJP) overlay.className = "neon-rgb";
            else overlay.className = currentResult.isMama ? "neon-purple" : "neon-yellow";
        }

        function checkResult() {
            if (isSpinning || !currentResult) return;
            let won = currentResult.isJP || (currentResult.isMama && userGuess === "mama") || (!currentResult.isMama && userGuess === "baba");
            
            if(won) {
                flow('win');
                if(currentResult.isJP) { 
                    sounds.jackpot.play(); 
                    spinCount = 0; 
                    jackpotGoal = Math.floor(Math.random() * 3) + 3;
                    for(let i=0; i<60; i++) spawn(true, ["ðŸ‘©","ðŸŒ","âœ¨","ðŸ¥³","â¤ï¸"]); 
                } else { 
                    sounds.win.play(); 
                    let winEmojis = currentResult.isMama ? ["ðŸ‘©","â¤ï¸","âœ¨"] : ["ðŸŒ","ðŸ’›","âœ¨"];
                    for(let i=0; i<30; i++) spawn(false, winEmojis);
                }
            } else {
                flow('fail');
                sounds.fail.play();
                for(let i=0; i<30; i++) spawn(false, ["ðŸš’","ðŸšœ","ðŸš€","ðŸ›¸","ðŸ¦","ðŸ˜","ðŸ¸","ðŸ¦"]);
            }
            currentResult = null;
        }

        function spawn(isJackpot, list) {
            const el = document.createElement('div');
            el.className = 'emoji';
            el.innerText = list[Math.floor(Math.random()*list.length)];
            document.body.appendChild(el);
            let x = isJackpot ? window.innerWidth/2 : Math.random()*window.innerWidth;
            let y = isJackpot ? window.innerHeight/2 : window.innerHeight+50;
            let vx = (Math.random()-0.5)*(isJackpot?40:15);
            let vy = isJackpot ? (Math.random()-0.5)*40 : -(Math.random()*20+15);
            let rot = 0;
            const anim = setInterval(() => {
                x += vx; y += vy; vy += 0.8; rot += 10;
                el.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${rot}deg)`;
                if(y > window.innerHeight + 200) { clearInterval(anim); el.remove(); }
            }, 20);
        }
    </script>
</body>
</html>
